<script type="text/javascript" src="~/Scripts/jquery-1.8.2.js"></script>
<link rel="stylesheet" type="text/css" href="~/Content/Rezultati.css">

<hgroup class="title">
    <h1>Olimpiāžu Rezultāti</h1>
</hgroup>
    <section id="gadi">
        <h3>Norises gads un rezultāti:</h3>
        <table id="yearTable"></table>
        <hr />
        <input type="button" onclick="toggleNewYear()" value="Pievienot gadu" class="button" />
        <div id="enterYear" hidden>
            Ievadiet gadu: <input id="newYearInput" maxlength="4" /><br />
            Izvēlieties rezultātu failu <select id="pdfSelect"></select><br />
            Publicēt rezultātus <input type="checkbox" id="publishResultsCbx"/><br />
            <input type="button" onclick="insertYear()" value="Pievienot" class="button" />
            <hr />
        </div>
        @using (Html.BeginForm("Upload", "Rezultati"))
        {
            <input type="submit" value="Augšupielādēt/Dzēst rezultātu failus" class="button" />
        }
        
    </section>

    <script type="text/javascript">
        var newYearVisibe = false;        
        
        $(document).ready(function () {
            getFiles();
            getYears();
        });

        function toggleNewYear() {
            if (newYearVisibe) hideNewYear();
            else showNewYear();
        }

        function showNewYear() {
            $("#newYearInput").val("");
            $("#enterYear").fadeIn();
            newYearVisibe = true;
        }

        function hideNewYear() {
            $("#enterYear").fadeOut();
            $("#newYearInput").val("");
            newYearVisibe = false;
        }

        //AJAX ***********************************************************************************

        function getYears() {
            $.ajax({
                type: "GET",
                url: "Rezultati/GetYears",
                dataType: "json",
                cache: false
            })
            .done(function (data) {
                var tableHTML = "";
                $.each(data, function (i, year) {
                    var checked = "";
                    var checkedArchive = "";
                    if (year.Publicets) { checked = "checked"; }
                    if (year.Arhivets) { checkedArchive = "checked"; }
                    tableHTML += "<tr><th>" + year.Gads + "</th><td style='padding-left:10px'><label>Publicēt <input id='publishResultsCbx2_" + year.RezultatsID + "' type='checkbox' " + checked + " onchange='UpdateYear(&quot;" + year.RezultatsID + "&quot;)' /></label></td><td><label>Rādīt arhīvā <input id='archiveResultsCbx2_" + year.RezultatsID.toString() + "' type='checkbox' " + checkedArchive + " onchange='UpdateYear(&quot;" + year.RezultatsID + "&quot;)' /></label></td><td><input type='button' value='Dzēst' onclick='deleteYear(" + year.RezultatsID + ")' class='button' /></td><td><input type='button' class='button' onclick='previewPdf(&quot;" + year.RezultatiLink + "&quot;)' value='Skatīt failu'/></td></tr>";
                });
                $("#yearTable").html(tableHTML);
                hideNewYear();
            })
        }

        function getFiles() {
            $.ajax({
                type: "GET",
                url: "Rezultati/GetFiles",
                dataType: "json",
                cache: false
            })
            .done(function (data) {
                var tableHTML = "";
                $.each(data, function (i, fails) {
                    tableHTML += "<option value='" + fails.Path + "'>" + fails.Name + "</option>";
                });
                $("#pdfSelect").html(tableHTML);
            })
        }

        function insertYear() {
            var inputYear = $("#newYearInput").val();
            var selectEl = $("#pdfSelect");
            var fileLink = "@@" + selectEl[0].value;
            var publish = $("#publishResultsCbx").is(":checked");

            $.ajax({
                type: "POST",
                url: "Rezultati/InsertYear",
                dataType: "text",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ year: inputYear, link: fileLink, publicet: publish })
            })
            .error(function (error) {
                alert(error.responseText);
            })
            .done(function () {
                hideNewYear();
                getYears();
            })
        }

        function deleteYear(id) {
            if (confirm("Dzēst?")) {
                $.ajax({
                    type: "POST",
                    url: "Rezultati/DeleteYear",
                    dataType: "text",
                    contentType: "application/json; charset=utf-8",
                    data: "{'id': '" + id + "' }"
                })
                .done(function () {
                    hideNewYear();
                    getYears();
                })
            }
        }

        function UpdateYear(id) {
            var publish = $("#publishResultsCbx2_" + id).is(":checked");
            var archive = $("#archiveResultsCbx2_" + id).is(":checked");

            $.ajax({
                type: "POST",
                url: "Rezultati/UpdateYear",
                dataType: "text",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ ID: id, publicet: publish, arhivet: archive })
            })
            .done(function () {
                hideNewYear();
                getYears();
            })
        }

        function previewPdf(_path) {
            //TODO: Get and preview PDF from _path
        }

    </script>